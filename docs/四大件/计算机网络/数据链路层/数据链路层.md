# 数据链路层
## 概述
- 链路: 指从一个结点到相邻结点的一段物理线路 (有线或无线), 而**中间没有任何其他的交换节点**![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231117102158.png)
- 数据链路: 基于链路, 但是在链路的基础上, **实现了相关的协议和软件**
	- 网络适配器 (Network Interface Controler, NIC, 网卡)与相应的软件驱动程序实现了相关的协议
> [!note] 网卡实现的内容
> 包括了物理层和数据链路层的功能
- 结点: 运行链路层协议的任何设备
	- 包括主机、路由器、交换机和 WiFi 接入点
- 帧: 是数据链路层对等实体之间在水平方向进行逻辑通信的协议数据单元 PDU ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231117102656.png)
- 数据链路层提供的服务: 
	- 成帧: 在每个网络层数据报经链路传送之前, 链路层协议都会将其用链路层帧封装起来
	- 链路接入: 规定帧在链路上传输的规则
	- 可靠交付: 链路层保证无差错的经链路层移动每个网络层数据报
	- 差错检测和纠正
## 数据链路层的三个重要问题
- 基本问题与解决方法:
	- [[数据链路层#封装成帧与透明传输|封装成帧]]: 发送结点的数据链路层将网络层的数据报文添加首部和尾部后封装成帧
		- 在网络层报文的前后分别添加首部和尾部 (**帧定界**), 构成一个帧<img src="https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2Fimage-20231103213114736.png" alt="image-20231103213114736" style="zoom:67%;" />
		- 帧的首部和尾部中包含有一些重要的**控制信息**
	- [[数据链路层#封装成帧与透明传输|透明传输]]: 数据报文中的任意数据都可以得到传输, 高层应用无须担心特殊字符的传输问题
		- 面向字节的物理链路: **字节填充**
		- 面向比特的物理链路: **比特填充**
       > 如果不实现透明传输, 链路层可能会将一个帧识别为多个帧<img src="https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2Fimage-20231103213253499.png" alt="image-20231103213253499" style="zoom: 67%;" />
       
	- [[数据链路层#差错控制|差错控制]]: 由于帧在传输的过程中可能出现误码, 接收方需要根据发送方在帧尾部添加的**检错码**来检测帧是否出现了误码
		- 奇偶校验
			 - 奇偶校验所存在的问题是**不能检测出偶数位误码**
		- 循环冗余校验
			- 基本思想: 
				- 收发双方约定好一个**生成多项式 $G(X)$**
				- 发送方基于待发送的数据和生成多项式, **计算出冗余码**, 将冗余码添加到帧尾部
				- 接收方通过生成多项式来计算收到的数据和冗余码是否产生了误码
	- [[数据链路层#可靠传输|可靠传输]]: 
		- 不可靠传输服务: 直接丢弃有误码的帧
		- 可靠传输服务: 实现发送方发送什么, 接收方最终都能正确收到
### 封装成帧与透明传输
- 最大传输单元MTU: 每一中数据链路层协议都规定了数据载荷的长度上限
- 透明传输的实现: 
	- 字符填充: 使用转义字符(`ESC`或`\`), 标志后面的是字节数据, 避免错误识别位帧定界
	- 零比特填充

### 差错控制
- **循环冗余码**
	- 选择一个 r 此多项式 G (x)作为生成多项式, 生成校验串的步骤
		1. 在信息位串后补 r 个 0, 对应的多项式为 $x^rM(x)$
		2. 用模 2 除运算, 计算余数 $R (x)=MOD(\frac{x^rM(x)}{G(x)})$
		3. 要发送的码字多项式 $T(x)=x^rM(x)+R(x)$
	- 发送方的操作 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231202145004.png)
	- 接收方的操作 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231202145023.png)


### 可靠传输
> [!note] 对于不同类型链路的可靠传输
> 一般情况下, 有线链路的误码率比较低. 为了减小开销, 并不要求数据链路层向其上层提供可靠的传输服务. 即使出现了误码, 可靠传输的问题也交给其上层处理.
> 而无线链路易受到干扰, 误码率较高, 因此要求数据链路层必须向其上层提供可靠的传输服务
- 出错类型: 
	- 误码
	- 分组丢失
	- 分组失序
	- 分组重复
> 可靠传输服务并不局限于数据链路层, 其他各层均可以选择实现可靠传输
> 可靠传输的实现比较复杂, 开销较大, 是否使用可靠传输取决于应用的需求
- 确认、否认和重传: 发送方**对接收方的否认分组进行重发**![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231117105510.png)
- 超时重传: 发送方启动一次超时计时器, 如果到了超时重传时间, 仍未收到接收方的ACK或NAK, 则重传之前的数据分组![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231117105555.png)
- 确认丢失, 分组编号: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231117105755.png)
- 确认迟到, 确认分组需要编号: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231117105906.png)
	- 使用超时重传的及之后, 就可以不使用否认机制了, 这样使协议实现起来更加简单
		- 如果点对点链路的误码率较高, 使用**否认机制可以使发送方在超时计时器超时前就尽快重传**

## 点对点 PPP 协议
### 点对点 PPP 概述
- 点对点 PPP (Point to Point Protocol)

### PPP 的帧格式
![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118141336.png)

### PPP 帧的透明传输
- 面向字节的**异步链路**使用**字节填充**来实现透明传输
	- 发送方的处理: 在帧定界和 ASCII 码控制字符前插入转义字符 `0x7D`
	- 接收方的处理: 进行相反的变换
- 面向比特的**同步链路**使用**零比特填充**来实现透明传输
	- 发送方的处理: 对帧的数据载荷进行扫描, 每出现 5 个连续的比特 1, 则在其后填充一个比特 0
	- 接收方的处理: 对帧的数据载荷进行扫描, 每出现 5 个连续的比特 1, 则将其后的一个比特 0 删除

### PPP 帧的差错检测
- 使用循环冗余校验 CRC

### PPP 的工作状态
![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118141815.png)


## 共享式以太网
### 网络适配器与 MAC 地址
#### 网络适配器
- 即网卡
- 通信方式 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118152637.png)
	- **网卡与 CPU** 之间的通信, 一般是通过计算机主板上的 **I/O 总线**并且以**并行**的方式传输
	- 网卡与外部以太网: 通过**传输媒介**, 以**串行方式**进行
- 功能: 
	- 实现物理层和数据链路层的功能
	- 进行并行传输和串行传输的**转换**
		- 由于网络的传输速率和计算机内部总线上的传输速率并不相同, 因此在网卡的核心芯片中都会包含**用于缓存数据的存储器**
- 网卡的驱动程序负责**驱动网卡发送和接收帧**

#### MAC 地址
- 在数据链路层中, 必须使用地址来区分各主机, 则每个主机都必须有一个唯一的标识, 即**数据链路层地址**
- 在每个主机发送的帧的首部中, 都携带有发送主机和接收主机的数据链路层地址
> [!note] 命名原因
> MAC (Medium Access Control, 媒体控制接入)
> MAC 地址一般被固化在网卡的电可擦可编程只读存储器中, 因此 MAC 地址也被称为硬件地址或物理地址
> 虽然称为物理地址, 但这是属于数据链路层的功能
- 一般情况下, 普通用户计算机中往往包含两块网卡:
	- 用于接入有线局域网的以太网卡
	- 用于接入无线局域网的 WiFi 网卡
- 每一块网卡都有一个全球唯一的 MAC 地址
> 交换机和路由器往往具有更多的网络接口, 所以会拥有更多的 MAC 地址
> 因此 MAC 地址是对网络上**各接口的唯一标识**, 而不是对网络上各设备的唯一标识
- MAC 地址格式: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118172650.png)
	- `b0`: Individial / Group
		- `0`: 单播地址
		- `1`: 多播地址
	- `b1`: Global / Local
		- `0`: 全球管理
		- `1`: 本地管理
- MAC 地址类型
	- 全球单播 `00`: 有厂商生产网络设备时固化在设备中
	- 全球多播 `01`: 交换机、路由器等标准网络设备所支持的多播地址
	- 本地单播 `10`: 由网络管理员分配, 优先级高于网络接口的全球单播地址
	- 本地多播 `11`: 可由用户对网卡编程实现, 以表明其属于哪些多播组
- MAC 地址的发送顺序
	- 字节发送顺序: 第 1 字节->第 6 字节
	- 字节内的比特发送顺序: `b0 -> b7`
- 单播 MAC 地址举例: ![单播MAC地址举例.gif](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F%E5%8D%95%E6%92%ADMAC%E5%9C%B0%E5%9D%80%E4%B8%BE%E4%BE%8B.gif)
- 广播 MAC 地址举例: ![广播MAC地址举例.gif](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F%E5%B9%BF%E6%92%ADMAC%E5%9C%B0%E5%9D%80%E4%B8%BE%E4%BE%8B.gif)
- 多播 MAC 地址举例: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118174227.png)
- 网卡从网络上每收到一个帧, 就检查帧首部中的目的 MAC 地址, 并按一下情况处理:
	- 广播地址 -> 接受
	- 与网卡上固化的全球单播 MAC 地址相同 -> 接受
	- 是网卡支持的多播地址 -> 接受
	- 否则, 丢弃
> [!note] 网卡的特殊工作模式
> 网卡还可以被设置为一种特殊的工作方式: 混杂方式
> 工作在混杂方式的网卡, 只要收到共享媒体上传来的帧就会收下, 而不管帧的目的 MAC 地址是什么.
> - 混杂方式的应用:
> 	- 对于网络维护和管理人员, 这种方式可以监视和分析局域网上的流量, 一遍找出提高网络性能的具体措施
> 	- 嗅探器就是一种工作在混杂方式的网卡, 再配合相应的工具软件, 就可以作为一种非常有用的网络工具来学习和分析网络
> 	- 黑客常利用这种方式非法获取网络用户的口令

> [!note] 安全问题
> 为了避免用户设备连接 WiFi 热点时候 MAC 地址泄漏的安全问题, 目前大多数移动设备都已经采用了随机 MAC 地址技术.

### CSMA/CD 协议
#### CSMA/CD 协议的基本原理
- 以太网发展的初期, 将多个站点连接在一条总线上来构建**共享总线以太网**
> [!note] 信号碰撞问题
> 以太网发展的初期, 将多个站点连接在一条总线上来构建**共享总线以太网**.
> 共享总线以太网具有天然的**广播特性**, 即使总线上某个站点给另一个站点发送单播帧, 该帧的信号也会沿着总线传播到其他的站点.
> 当某个站点在总线上发送帧时, 总线资源会被该站点独占. 此时, 如果总线上的其他站点也要在总线上发送帧, 就会产生信号碰撞.
> 当两个或多个站点同时使用总线发送帧时, 就会产生信号碰撞.
> 这就引出了共享总线以太网的一个重要问题: 如何协调总线上的各站点争用总线.
> CSMA/CD (Carrier Sense Multiple Access Collision Detection, 载波监听多址接入/碰撞检测) 正是为了解决这类的问题而存在
- 基本原理:
	- **多址接入**: 多个站点连接在一条总线上, 竞争使用总线
	- **载波监听**: 每个站点在发送帧之前, 先要检测一下总线上是否有其他站点 在发送帧
	- **碰撞检测**: 每个发送帧的站点变发送边检测碰撞
		- 检测到碰撞, 则停止发送, 退避随机时间
		- 强化碰撞:发送帧的站点一旦检测到碰撞, 除了立即停止发送帧外, 还要继续发送32比特或48比特的认为干扰信号, 以便有足够多的碰撞信号使所有站点都能检测出碰撞
- 工作机制: 
	- 载波监听: 
		- 若检测到总线空闲96比特时间, 则发送当前帧
		- 若检测到总线比较忙, 则继续检测并且等待总线转为空闲96比特时间
	- 碰撞检测:
		- 一旦发现总线上出现碰撞, 则立即停止发送, 退避一段随机时间后再次从载波监听开始发送
> [!note] 某个站点从发送帧开始, 最长要经过多长时间, 才能检测出自己发送的帧与其他站点发送的帧产生了碰撞?
> ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118203231.png)
> 站点从发送帧开始, 最多经过$2\tau$(即$\delta \rightarrow 0$)就可以检测出所发送的帧是否遭遇了碰撞
> 因此, 共享总线以太网的端到端往返时间$2\tau$被称为**争用期或碰撞窗口**
> **如果站点从发送帧开始, 经过争用期还没有检测到碰撞, 就可以肯定这次发送不会产生碰撞**
> 从争用期的概念可以看出, 共享总线以太网上的每一个站点从发送帧开始, 到之后的一小段时间内, 都有可能遭到碰撞, 而这一小段时间的长短是不确定的, 它**取决于另一个发送帧的站点与本站点的距离**
> 因此, 总线的长度越长, 网络中的站点数量越多, 发生碰撞的概率就越大
- 最小帧长的计算: $传输速率 \times 争用期 = 最小帧长$

#### 共享式以太网的退避算法
- 当检测到碰撞时就立即停止发送, 退避一段随机时间后再重新发送
- 随机时间的选择: 截断二进制指数退避![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231118205234.png)
	- 如果连续多次发送碰撞, 则表明可能有较多的站点参与竞争, 使用该腿比算法可**使重传需要推迟的平均时间随重传次数而增大, 因此减小了产生碰撞的概率**
	- 当重传达16次仍然不能成功时候, 应当放弃重传并向高层报告

#### 共享式以太网的信道利用率
- $$
S_{max}=\frac{T_0}{T_0+\tau}=\frac{1}{1+\frac{\tau}{T_0}}
$$
	- $S_{max}$极限信道利用率
	- $T_0$帧本身的发送时间(端从队列中送入链路的时间)
	- $\tau$信道上的传输时间
- 提高利用率的方法: 
	- 减小信道的长度
	- 帧的长度应尽量大, 延长帧发送时间

### 使用集线器的共享式以太网
> [!note] why
> 实践证明使用这种无源电缆线和大量机械接口的总线型以太网并不可靠. ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119105123.png)
> 若总线上的某个机械连接点接触不良或断开, 则整个网络通信就不稳定或彻底断网
- **集线器** Hub: 使用大规模继承电路来替代总线, 并且可靠性非常高
	- 站点连接到集线器的传输媒体 -> **双绞线电缆**
- 集线器的特点: 
	- **物理拓扑为星型网**, 但是在**逻辑上仍然是一个总线网**
	- 总线上的各站点**共享总线资源**, 使用的依旧是 **CSMA/CD** 协议
	- 集线器只工作在**物理层**, 它的每个接口仅**简单的转发比特**, 并不进行碰撞检测
		- **碰撞检测的任务依旧由各站点中的网卡负责**
	- 具有少量的**容错能力和网络管理功能**
		- 若网络中的某个站点的网卡出现了故障而不停发送帧, 集线器可以检测到这个问题, 并在内部断开与出故障网卡的连线, 使整个以太网能够正常工作

> [!info] 10 BASE-T
> 里程碑, 为以太网在局域网中的统治地位奠定了牢固的基础
> 10 BASE-T 以太网的通信距离较短, 每个站点到集线器的距离不能超过 100m
> ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119105930.png)

### 在物理层扩展以太网
#### 扩展站点与集线器之间的距离
> [!note] why
> 共享总线以太网中两站点之间的距离不能太远, 否则它们之间所传输的信号就回衰减到使 CSMA/CD 协议无法正常工作
- 扩大网络的地理覆盖范围的方法: **部署工作在物理层的转发器**
> [!tip] IEEE 802.3 的规定
> IEEE 802.3 规定, 两个网段可以使用一个转发器连接起来, 任意两个站点之间最多可以经过三个网段
> ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119110603.png)

> [!seealso] 10 BASE-T 星型以太网中的扩展方式
> 可以使用**光纤**和**一对光纤调制解调器**来扩展站点与集线器之间的距离
> 由于信号在光纤中的衰减和失真很小, 因此使用这种方法可以很简单的将站点与集线器之间的距离扩展到 1000 以上
#### 扩展共享式以太网的覆盖范围和站点数量
- 如果要连接的站点数量超过了单个集线器能够提供的接口数量, 就需要使用多个集线器
	- 这样就可以连接成覆盖范围更大、连接更多站点的多级星型以太网 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119111224.png)
- 缺点: 将多个小的碰撞域组成了一个更大的碰撞域 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119111300.png)

### 在数据链路层扩展以太网
#### 使用网桥在数据链路层扩展以太网
> [!note] 网桥 Bridge
> 网桥顾名思义, 就是将两个独立的星型网通过网桥连接起来, 使两个独立的星型网之间能够相互通信
- 网桥: 工作在数据链路层, 因此网桥**具备属于数据链路层范畴的相关能力**
	- 可以识别帧的结构
	- 可以**根据帧首部中的目的 MAC 地址和网桥自身的帧转发表来转发或丢弃所收到的帧**

#### 网桥的主要结构和基本工作原理
- 主要结构: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119111903.png)
- 基本工作原理: ![网桥的基本工作原理.gif](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F%E7%BD%91%E6%A1%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.gif) ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119112150.png)![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119112208.png)

#### 透明网桥的自学习和转发帧的流程
- 网桥中的转发表是如何建立的?
	- 透明网桥通过自学习算法建立
> [!note] 透明网桥
> 透明网桥中的透明, 指以太网中的各站点并不知道自己所转发的帧会经过哪些网桥的转发, 最终到达目的站点.
> 即, 以太网中的各网桥对各站点而言是看不见的
- 透明网桥的自学习算法: ![透明网桥的自学习算法.gif](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F%E9%80%8F%E6%98%8E%E7%BD%91%E6%A1%A5%E7%9A%84%E8%87%AA%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95.gif)
- 转发帧的三种情况: 
	- 明确转发
	- 盲目转发
	- 丢弃
> [!attention] 
> - 如果网桥收到有误码的帧则直接丢弃
> - 如果网桥收到一个无误码的广播帧, 则无须进行查表, 而是直接从除该该广播帧的接口的其他接口转发该广播帧
> - **转发表中的每条记录都有其有效时间, 到期将自动删除**
> 	- 因为各站点的 MAC 地址与网桥接口的对应关系不是永久性的, 若某个站点更换了网卡, 其 MAC 地址就会改变

#### 透明网桥的生成树协议 STP
- 为了提高以太网的可靠性, 有时需要在两个以太网之间**使用多个透明网桥来提供冗余链路**
	- 但在提供了冗余性的同时, 也引入了**环路**, 导致网络中的广播帧将在环路中永久兜圈, 造成广播帧充斥整个网络
- 生成树协议 STP: 在增加冗余链路提高网络可靠性的同时, 又避免了环路代理的问题
	- 不论网桥之间连接成了怎样复杂的带环拓扑, 网桥之间通过交互网桥协议单元, 找出原网络拓扑的一个连通子集 (**生成树**), **在这个子集中的整个连通网络都不存在环路**![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119114005.png)
	- 当首次连接网桥或网桥拓扑发生变化时候, 网桥都会重新构建生成树, 以确保网络的连通

## 交换式以太网
### 交换式以太网
- **交换式集线器** (Switching Hub): 实质上是具有多个接口的网桥, 称为以**太网交换机**
	- 与网桥相同, 交换机内部的转发表也是通过自学习算法, 基于网络中各主机间的通信, 自动地逐步建立起来的
	- 交换机也使用生成树协议 STP, 来产生能够连通全网但不产生环路的通信路径
- 仅使用交换机的以太网就是**交换式以太网**

### 以太网交换机
- 交换机的每个接口可以**连接计算机**, 也可以连接**集线器或另一个交换机**
	- 当交换机的接口与**计算机或交换机**相连时候, 可以工作在**全双工方式**, 并能在自身内部**同时连接多对接口**, 可以达到每一对相互通信的计算机都能像**独占传输媒体**那样, **无碰撞的传输数据**, 就不在需要 CSMA/CD 协议了
	- 而当交换机的接口是集线器时候, 该接口就只能使用 CSMA/CD 协议, 并且只能工作在半双工模式
- 一般的交换式都使用**存储转发**的方式
- 为了减小交换机的转发时延, 部分交换机采用了直通 (Cut-Througn) 交换方式
	- 直通交换方式: 在接收帧的同时就立即按帧的目的 MAC 地址决定该帧的转发接口, 然后通过其内部基于硬件的交叉矩阵进行转发, 而不需要先缓存后转发
		- 时延小
		- 直通交换不检查差错就直接将帧转发出去, 有可能会将一些无效帧转发给其他主机

### 共享式以太网与交换式以太网的对比
- 都扩大了广播域
- 共享式以太网扩大了碰撞域, 交换式以太网隔离了碰撞域

## 以太网的 MAC 帧格式
![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119135428.png)

## 虚拟局域网
- 使用交换机构成的巨大的广播域会带来一系列的问题: 
	- 广播风暴: 浪费网络资源和各主机的 CPU 资源
		- 使用路由器来分割广播域的成本较高

### 虚拟局域网 VLAN 概述
- 虚拟局域网: 将局域网内的站点划分成与物理位置无关的逻辑组
	- 属于同一个 VLAN 的站点之间可以直接进行通信, 而不同 VLAN 中的站点不能直接通信
	- 网络管理员可对局域网中的个交换机进行配置来建立多个逻辑上独立的 VLAN
> [!attention] 
> 虚拟局域网 VLAN 并不是一种新型的网络, 只是局域网能够提供给用户的一种服务

### 虚拟局域网 VLAN 的实现机制
- 最常见的实现方法: 基于以太网交换机的接口来实现 VLAN
	- 要求以太网交换机能够实现一下两个功能: 
		- 能够处理带有 VLAN 标记的帧, 即 `IEEE 802.1Q` 帧
		- 交换机的接口可以支持不同的接口类型, 不同的接口类型的接口对帧的处理方式有所不同
- `IEEE 802.1Q` 帧: 在原地址字段和类型字段之间插入了 4 字节的 VLAN 标签 (tag) ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119140612.png)
	- 标签内容: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119140649.png)
		- 标签协议标识符 TPID: 固定 `0x8100`, 表示此帧为 `IEEE 802.1Q` 帧
		- 优先级 PRI: 值越大优先级越高. 
			- 当网络阻塞时候, 设备优先发送优先级高的帧
		- 规范格式指示符 CFI: 1 bit
			- `0`: 表示 MAC 地址以规范格式封装
			- `1`: 表示 MAC 地址以非规范格式封装
		- 虚拟局域网标识符 VID: 用于识别 VLAN
- `802.1Q` 帧一般不由用户主机处理, 而是**由以太网交换机来处理**
	- **当交换机收到普通的以太网 MAC 帧时候**, 会**插入 4 字节的 VLAN 标签**
	- **当交换机转发 `802.1Q` 帧时候**, 可能会**删除 4 字节的 VLAN 标签**, 使之**成为普通的以太网 IMAC 帧**
- 以太网交换机的接口类型: 
	- 根据**接口在接收帧和发送帧时对帧的处理方式的不同**, 以及**接口连接对象的不同**, 以太网交换机的接口类型一般分为 **Access** 和 **Trunk** 两种
		- Access 连接到主机, 只能通过 PVID 值与其所属 VLAN 的 ID 相同的帧
		- Trunk 连接到其他交换机, 可以通过属于不同 VLAN 的帧
	- 若未进行设置, 接口类型默认为 Access, PVID 为 1 (即默认划分到 1 号虚拟局域网)
> [!seealso] Hybrid 接口
> Hybrid 接口是华为交换机私有的接口类型.
> 既可以用于交换机之间的互联, 也可以用于交换机与用户计算机之间的互联.
> 除此之外, Hybrid 接口的绝大部分功能与 Trunk 接口相同, 不同点在于 Hybrid 接口的转发处理: Hybrid 接口会查看帧的 VID 值是否在接口的"去标签"列表中, 若存在, 则去标签后转发, 不存在则直接转发
- 举例: ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119142240.png)![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119142214.png)

## 以太网的发展

## 802.11 无线局域网
### 802.11 无线局域网的组成
- 802.11 无线局域网的分类: 
	- 有固定基础设施: 预先建立的, 能够覆盖一定地理范围的, **多个固定的通信基站**![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119143844.png)
		- 基本服务: 
			- 关联服务: 移动站与接入点 AP 建立关联
				- 关联的方法: 被动扫描, 主动扫描
			- 重建关联服务: 移动站吧与某个接入点 AP 的关联转移到另一个 AP
			- 分离服务: 终止关联服务
	- 无固定基础设施
		- 自组织网络: 无须基站, 具有良好的生存性 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119144247.png)

### 802.11 无线局域网的物理层

### 802.11 无线局域网使用 CSMA/CA 协议的原因
- 由于传输介质不同, 无法使用 CSMA/CD 协议
	- 从碰撞检测 CD 变为了碰撞避免 CA, 尽可能避免碰撞
- 不采用 CD 的原因:
	- 无线信道的传输环境复杂且信号强度的动态范围非常大, 在 802.11 无线网卡上接收到的信号强度一般都远远小于发送信号的强度, 如果要在无线网卡上实现碰撞检测, 对**硬件的要求非常高**
	- 即使能够在硬件上实现碰撞检测的功能, 但由于**无线电波传播的特殊性**, 还是会出现无法检测到碰撞的情况, 因此**碰撞检测并没有意义**![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119144820.png)

### CSMA/CA 协议的基本工作原理
- DCF (Distrubuted Coordination Function), 分布式协调功能
	- 在 DCF 方式下, 没有中心控制站点, 每个站点使用 CSMA/CA 协议通过争用信道来获取发送权
	- DCF 方式是 802.11 定义的默认方式, 必须实现
- DIFS: DCF 帧间间隔, 为 $128 \mu s$
	- 在 DCF 方式中, DIFS 用来发送数据帧和管理帧
- 帧首部中的持续时间: 指出了源站点要占用信道的时间
- NAV (Network Allocation Vector), 网络分配向量
	- 指出了完成这次帧的传送且信道转入空闲状态所需要的时间
- SIFS (Short Interframes Space)短帧间间隔, 为 $28\mu s$
	- 用来分隔开属于一次对话的各帧
	- 一个站点应当能够在这段时间内从发送方式切换到接收方式
> [!note] 
> 由于无线信道的误码率较高, CSMA/CA 协议还需要使用停止等待的确认机制来实现可靠传输, 这与使用 CSMA/CD 协议的共享式以太网不同

![CSMACA协议.gif](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2FCSMACA%E5%8D%8F%E8%AE%AE.gif)
- 退避算法:
	- 在执行退避算法时, 站点为退避计时器设置一个随机的退避时间
		- 当退避计时器的时间**减小到 0 时, 就开始发送数据**
		- 当退避计时器的时间还未减小到零时候而信道又转变为忙, 这时就**冻结**退避计时器的数值, **重新等待信道变为空闲**, 再经过帧间间隔 DIFS 后, 继续起算点退避计时器
	- 退避时间在时隙编号 $\{0, 1, \cdots, 2^{2+i}-1\}$ 中随机选择一个, 然后乘以基本退避时间 (一个时隙的长度), 就可以获得随机的退避时间
- 为了进一步降低发生碰撞的概率, 802.11 无线局域网允许源站对信道进行**预约**![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119165510.png)

### 802.11 无线局域网的 MAC 帧
- 数据帧: 用于在站点间传输数据 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119165856.png)
	- 数据帧中的四个地址取决于帧控制字段中的"去往 DS (Distribution System)"和"来自 DS"这两个字段的值 ![image.png](https://jiunian-pic-1310185536.cos.ap-nanjing.myqcloud.com/picgo%2F20231119170049.png)
- 控制帧: 通常与数据帧搭配使用, 负责区域的清空, 虚拟载波监听的维护以及信道的接入, 并于收到数据帧时予以确认
	- ACK 帧, RST 帧以及 CTS 帧都属于控制帧
- 管理帧: 用于加入或退出无线网络, 以及处理 AP 之间连接的转移事宜
	- 信标帧, 关联请求帧以及身份认证帧等都属于管理帧