# 虚拟内存
## 概述
- 虚拟内存是硬件异常、硬件地址翻译、主存、磁盘文件和内核软件的完美交互
	- 为每一个进程提供了一个大的、一致的、私有的地址
- 虚拟内存所提供的的三个重要的能力：
	- 将主存看做是一个存储在磁盘上的地址空间的高速缓存
		- 在主存中止保存活动区域，并且根据需要在磁盘和主存之间来回传送数据
		- 通过这种方式，高效的使用了主存
	- 为每个进程提供了一致的地址空间，从而简化了内存管理
	- 保护了每个进程的地址空间不被其他进程破坏
- 程序员需要了解虚拟内存的原因：
	- 虚拟内存是核心的
	- 虚拟内存是强大的
	- 虚拟内存是危险的

## 物理与虚拟寻址
> [!note] 主存
> 计算机系统的主存被组织为一个由$M$个连续字节大小的单元组成的数组。
- 物理地址
- 物理寻址![image.png](https://raw.githubusercontent.com/alwaysmissin/picgo/main/20230723133253.png)
- 虚拟**寻址**：![image.png](https://raw.githubusercontent.com/alwaysmissin/picgo/main/20230723133314.png)
	- 使用虚拟寻址，CPU通过生成一个虚拟地址来访问主存
	- 这个虚拟地址在被传送到内存之前转换成适当的物理地址
	- 将一个虚拟地址转换为物理地址的任务叫做**地址翻译**
		- **地址翻译需要CPU硬件和操作系统之间紧密合作**
> [!note] MMU内存管理单元(Memory Management Unit)
> CPU芯片上叫做内存管理单元的专用硬件，利用**存放在主存中的查询表**来动态翻译虚拟地址。
> 该表的内容由操作系统管理。

## 地址空间
- 地址空间：地址空间是一个非负整数地址的有序集合
> [!note] 地址空间
> 地址空间区分了数据对象（字节）和他们的属性（地址）
> 理解了地址空间的概念后，我们就可以允许每个数据对象有多个独立的地址，其中每个地址都选自一个不同的地址空间。
> 这就是虚拟内存的基本思想
> 主存中的每个字节都有一个选自虚拟地址空间的虚拟地址和一个选自物理地址空间的物理地址

## 虚拟内存作为缓存的工具
> [!note] 虚拟内存与缓存
> 在概念上，虚拟内存被组织为一个存放在磁盘上的N个连续的字节大小的单元组成的数组。每个字节都有一个为一个虚拟地址，作为到数组的索引。磁盘上数组的内容被缓存在主存中。
> 与存储器层次结构中其他缓存一样，磁盘上的数据被分割为块，这些块作为磁盘和主存之间的传输单元。
> VM系统通过将虚拟内存分割为**虚拟页**，每个虚拟页的大小为$P=2^p$字节
> 类似的，物理内存被分割为物理页（页帧），大小也为$P$字节
- 虚拟页面的集合分类：
	- 未分配的
	- 缓存的
	- 未缓存的
![image.png](https://raw.githubusercontent.com/alwaysmissin/picgo/main/20230723134333.png)

### DRAM缓存的组织结构
- DRAM缓存表示虚拟内存系统的缓存，它在**主存**中缓存虚拟页
> [!note] SRAM缓存
> SRAM缓存表示**位于CPU和主存之间的L1、L2和L3高速缓存**
- DRAM缓存的组织结构是由巨大的不命中开销驱动的
	- 由于DRAM的速度比SRAM慢，因此DRAM缓存不命中的代价比SRAM缓存不命中的代价要昂贵的多
	- 从磁盘的一个删去读取一个字节的时间开销比读这个删去中连续的字节要慢大约100 000倍

### 页表
> 与任何缓存一样，虚拟内存系统必须有某种方法来判定一个虚拟页是否缓存在DRAM中的某个地方。
> 如果是，系统还需要确定这个虚拟页存放在哪一个物理页中。
> 如果不命中，系统还需要判断这个虚拟页存放在磁盘的那个位置，在物理内存中选择一个牺牲页，并且将虚拟页从磁盘中赋值到DRAM中，替换这个牺牲页。
> 这些功能需要有软硬件联合提供，包括：**操作系统软件、MMU、页表**
- **页表**：页表将虚拟页映射到物理页![image.png](https://raw.githubusercontent.com/alwaysmissin/picgo/main/20230723135300.png)
	- **每次地址翻译硬件将一个虚拟地址转换为物理地址的识别，都会读取页表**
	- **操作系统负责维护页表的内容**，以及在磁盘与DRAM之间来回传送页
- PTE(Page Table Entry)：有效位+物理页号或磁盘地址
	- 有效位：表明该虚拟页当前是否被缓存在DRAM中
		- 如果设置了有效位，则地址字段就表示**DRAM**中相应的物理页的起始位置
		- 如果还未设置有效位
			- 空地址表示这个**虚拟页还未被分配**
			- 地址指向虚拟页在**磁盘**上的起始位置

### 页命中

### 缺页
- DRAM缓存不命中称为缺页
![image.png](https://raw.githubusercontent.com/alwaysmissin/picgo/main/20230723140136.png)
![image.png](https://raw.githubusercontent.com/alwaysmissin/picgo/main/20230723140143.png)
> [!note] 交换
> 在磁盘和内存之间传送页的活动叫做**交换**或**页面调度**。
> 页从磁盘换入DRAM和从DRAM换出磁盘
> 一直等待，直到最后时刻，也就是当有不命中发生时，才换入页面的这种策略称为**按需页面调度**
> 也可以使用其他方法，例如尝试预测不命中，在页面实际被引用之前就换入页面。
> 现代系统所使用的的都是按需页面调度方法

## 虚拟内存作为内存管理的工具

## 虚拟内存作为内存保护的工具
